<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Live Transcriber — Whisper via Apps Script</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --gap:12px; --border:#e5e7eb; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    header{ display:flex; gap:var(--gap); align-items:center; padding:var(--gap); border-bottom:1px solid var(--border); flex-wrap:wrap; }
    header input{ flex:1 1 320px; padding:8px 10px; border:1px solid var(--border); border-radius:10px; }
    header button{ padding:8px 12px; border:1px solid var(--border); background:#111; color:#fff; border-radius:10px; cursor:pointer; }
    main{ display:grid; grid-template-columns: 1.2fr 1fr; min-height: calc(100vh - 60px); }
    #player-wrap{ padding:var(--gap); }
    #player{ width:100%; max-width:960px; aspect-ratio:16/9; background:#000; }
    #transcript{ padding:var(--gap); border-left:1px solid var(--border); overflow:auto; }
    .line{ margin:8px 0; }
    .ts{ cursor:pointer; text-decoration:underline; margin-right:6px; }
    .meta{ color:#6b7280; font-size:12px; }
    .status-dot{ display:inline-block; width:10px; height:10px; border-radius:50%; background:#9ca3af; margin-right:6px; vertical-align:middle; }
    .status-dot.live{ background:#10b981; }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  </style>
  <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
  <header>
    <input id="ytUrl" type="text" placeholder="Paste YouTube Live URL (optional)" />
    <button id="load">Load</button>

    <div class="toolbar">
      <button id="start">Start (pick tab/window)</button>
      <button id="stop">Stop</button>
      <button id="exportTxt">Export .txt</button>
      <button id="exportJson">Export .json</button>
    </div>

    <span class="meta"><span id="dot" class="status-dot"></span><span id="status">idle</span></span>
  </header>

  <main>
    <section id="player-wrap">
      <div id="player"></div>
      <div class="meta" style="padding:8px 0">
        Click <b>Start</b>, choose the tab/window that’s playing the livestream, and check “Share audio”. No drivers or sound settings needed.
      </div>
    </section>
    <aside id="transcript"></aside>
  </main>

<script>
/* ====== SET THIS TO YOUR APPS SCRIPT WEB APP URL (ends with /exec) ====== */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzG8jkvaUiGHIYKUjl5jsi0r2fO0Yenj5QPvdmi0y_DiMGJSWZe2JQLxoXtOZU21NF5Jw/exec";
/* ======================================================================= */

let player, startedAt=0, mediaStream=null, recorder=null;

function onYouTubeIframeAPIReady(){
  player = new YT.Player('player', { height:'390', width:'640', videoId:'', playerVars:{ autoplay:0, playsinline:1, modestbranding:1 }});
}
function parseYouTubeId(url){
  if (!url) return '';
  let m = url.match(/[?&]v=([A-Za-z0-9_-]{6,})/); if (m) return m[1];
  m = url.match(/youtu\.be\/([A-Za-z0-9_-]{6,})/); if (m) return m[1];
  m = url.match(/youtube\.com\/live\/([A-Za-z0-9_-]{6,})/); if (m) return m[1];
  m = url.match(/youtube\.com\/embed\/([A-Za-z0-9_-]{6,})/); if (m) return m[1];
  return '';
}
document.getElementById('load').onclick = () => {
  const url = document.getElementById('ytUrl').value.trim();
  const id = parseYouTubeId(url);
  if (id) player.loadVideoById(id);
};

function secToClock(sec){
  sec = Math.max(0, Math.floor(sec));
  const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
  return (h? String(h).padStart(2,'0')+':' : '') + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
}
function addLine(text, startSec){
  const div = document.createElement('div'); div.className = 'line';
  const a = document.createElement('span'); a.className = 'ts';
  a.textContent = '[' + secToClock(startSec) + ']';
  a.onclick = () => player?.seekTo && player.seekTo(startSec, true);
  const t = document.createElement('span'); t.textContent = ' ' + text;
  div.appendChild(a); div.appendChild(t);
  const pane = document.getElementById('transcript');
  pane.appendChild(div); pane.scrollTop = pane.scrollHeight;
}
function setStatus(msg, live=false){
  document.getElementById('status').textContent = msg;
  document.getElementById('dot').classList.toggle('live', !!live);
  console.log('[status]', msg);
}

// --- patched Start/Stop handlers ---
document.getElementById('start').onclick = async () => {
  try{
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      console.warn('getDisplayMedia usually requires HTTPS. Use GitHub Pages or localhost.');
    }

    // Ask for VIDEO + AUDIO; audio-only often throws NotSupportedError
    const constraints = {
      video: true,
      audio: {
        echoCancellation: false,
        noiseSuppression: false,
        autoGainControl: false
      }
    };
    mediaStream = await navigator.mediaDevices.getDisplayMedia(constraints);

    // Immediately stop the video track; we only need audio
    const vtrack = mediaStream.getVideoTracks()[0];
    if (vtrack) vtrack.stop();

    const atrack = mediaStream.getAudioTracks()[0];
    if (!atrack) {
      alert('No audio track captured. Pick the tab with sound and check “Share tab audio”.');
      return;
    }

    // Recorder with robust mime fallback
    let mime = '';
    if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
      mime = 'audio/webm;codecs=opus';
    } else if (MediaRecorder.isTypeSupported('audio/webm')) {
      mime = 'audio/webm';
    } else if (MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')) {
      mime = 'audio/ogg;codecs=opus';
    } // else leave mime empty and let browser choose

    recorder = mime ? new MediaRecorder(mediaStream, { mimeType: mime, audioBitsPerSecond: 128000 })
                    : new MediaRecorder(mediaStream);

    startedAt = Date.now();
    setStatus('listening…', true);

    recorder.ondataavailable = async ev => {
      if (!ev.data || ev.data.size === 0) return;
      const offsetMs = Date.now() - startedAt;
      await sendChunk(ev.data, offsetMs);
    };

    recorder.start(5000); // 5s chunks
  }catch(err){
    // Common causes:
    // - Picked a window/screen without system audio
    // - Didn’t check “Share tab audio”
    // - Unsupported browser (Safari/iOS)
    setStatus('error: ' + (err?.message || String(err)), false);
  }
};

document.getElementById('stop').onclick = () => {
  try { recorder?.stop(); } catch {}
  try { mediaStream?.getTracks().forEach(t => t.stop()); } catch {}
  setStatus('stopped', false);
};

async function sendChunk(blob, offsetMs){
  try{
    const fd = new FormData();
    fd.append('audio', blob, 'chunk.webm'); // Apps Script sees this as e.files.audio

    const r = await fetch(WEBAPP_URL, { method: 'POST', body: fd });
    const data = await r.json();

    if (data && data.ok && data.text) {
      const text = data.text.trim();
      const secs = Math.floor(offsetMs/1000);
      addLine(text, Math.max(0, secs - 2));
    } else if (data?.error) {
      console.warn('Whisper error', data);
      setStatus('Whisper error (see console)', false);
    }
  } catch (e) {
    console.error('sendChunk failed', e);
  }
}

// exports
document.getElementById('exportTxt').onclick = () => {
  const lines = [...document.querySelectorAll('.line')].map(div => div.textContent.trim());
  const blob = new Blob([lines.join('\n')], {type:'text/plain'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'transcript.txt'; a.click(); URL.revokeObjectURL(a.href);
};
document.getElementById('exportJson').onclick = () => {
  const out = [...document.querySelectorAll('.line')].map(div => {
    const ts = div.querySelector('.ts')?.textContent?.replace(/\[|\]/g,'') || '00:00';
    const text = div.textContent.replace(/\[.*?\]\s*/, '').trim();
    return { ts, text };
  });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify({ lines: out }, null, 2)], {type:'application/json'}));
  a.download = 'transcript.json'; a.click(); URL.revokeObjectURL(a.href);
};
</script>
</body>
</html>
